# Stage 1: 開発環境用（Docker Compose向け）
FROM migrate/migrate AS dev

# docker-compose-waitをダウンロードして、MySQLなどの依存が立ち上がるまで待つ
ADD https://github.com/ufoscout/docker-compose-wait/releases/download/2.9.0/wait /wait
RUN chmod +x /wait

# エントリーポイント用スクリプトを追加
COPY entrypoint.sh /usr/local/bin
RUN chmod +x /usr/local/bin/entrypoint.sh

# マイグレーション用SQLファイルを追加
COPY ./ /migrations

# エントリーポイントとして entrypoint.sh を実行
ENTRYPOINT [ "/usr/local/bin/entrypoint.sh" ]


# Stage 2: 本番環境用（Kubernetes向け）
FROM migrate/migrate AS prod

# 本番環境用はwaitは不要なので、シンプルにスクリプトとマイグレーションをコピー
COPY entrypoint.sh /usr/local/bin
RUN chmod +x /usr/local/bin/entrypoint.sh

# マイグレーション用SQLファイルを追加
COPY ./ /migrations

WORKDIR /migrations
# エントリーポイントとして entrypoint.sh を実行
ENTRYPOINT [ "/usr/local/bin/entrypoint.sh" ]

CMD ["up"]
